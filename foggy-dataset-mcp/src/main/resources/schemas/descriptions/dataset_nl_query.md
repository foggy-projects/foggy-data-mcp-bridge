# dataset_nl.query 工具描述

## 工具描述

使用自然语言查询数据集，支持自动生成图表。这是M1层的统一查询入口，面向外部Agent提供智能数据查询服务。

### 核心功能
- **自然语言查询**: 支持中文自然语言查询，无需了解底层数据结构
- **智能图表生成**: 根据查询类型自动生成趋势图、对比图、占比图等
- **AI意图识别**: 智能识别用户查询意图并优化查询策略

### 可视化输出支持
- **趋势分析**: 自动生成折线图（LINE）展示数据趋势
- **分类对比**: 自动生成柱状图（BAR）进行分类对比
- **占比分析**: 自动生成饼图（PIE）展示数据占比
- **云端托管**: 图表URL云端托管，可直接嵌入或展示

### 响应格式
响应包含标准化的 `exports` 字段结构：

**exports字段结构**：
```json
{
  "exports": {
    "charts": [
      {
        "url": "https://chart.example.com/image.png",
        "type": "LINE|BAR|PIE",
        "title": "具体的图表标题",
        "format": "PNG|JPG|SVG",
        "width": 800,
        "height": 600,
        "expiresAt": "2025-09-22T12:00:00Z"
      }
    ]
  }
}
```

### 使用示例

**趋势分析查询**：
```json
{
  "query": "查询近一周的运单趋势"
}
```
返回：数据 + 折线图（标题：近一周运单趋势图）

**分类统计查询**：
```json
{
  "query": "按客户类型统计订单数量"
}
```
返回：数据 + 柱状图（标题：客户类型分布图）

**占比分析查询**：
```json
{
  "query": "分析各地区销售占比"
}
```
返回：数据 + 饼图（标题：各地区销售占比图）

**分页查询**：
```json
{
  "query": "查询客户信息",
  "cursor": "eyJvZmZzZXQiOjEwMH0="
}
```
返回：下一页数据

**上下文查询**：
```json
{
  "query": "再查询一下订单信息",
  "session_id": "session_123"
}
```
返回：基于上下文的查询结果

## 参数说明

### query (必填)
- 类型: string
- 说明: 自然语言查询内容，使用中文描述查询需求
- 支持的查询类型:
  - **明细查询**: "查询客户信息"、"找出北京地区的企业客户"
  - **统计查询**: "按团队统计订单数量"、"计算各地区销售总额"
  - **趋势分析**: "近一周的运单趋势"、"最近30天的销售变化"
  - **对比分析**: "对比各网点的业绩"、"不同客户类型的订单量"
  - **占比分析**: "各地区销售占比"、"客户类型分布"
- 示例:
  - `"查询客户信息"`
  - `"按团队统计订单数量"`
  - `"找出北京地区的企业客户"`
  - `"近一周各网点的开单趋势"`

### session_id (可选)
- 类型: string
- 说明: 会话ID，用于保持上下文连续性
- 作用:
  - 记住之前的查询结果
  - 保持模型信息的上下文
  - 支持连续的追问和细化查询
- 示例: `"session_123"`

### cursor (可选)
- 类型: string
- 说明: 分页游标，用于获取下一页数据
- 使用方式: 从上次查询响应的 `nextCursor` 字段获取
- 示例: `"eyJvZmZzZXQiOjEwMH0="`

### format (可选)
- 类型: string
- 说明: 输出格式
- 可选值:
  - `table`: 表格显示格式（适合查看明细数据）
  - `json`: JSON结构化数据（适合程序处理）
  - `summary`: 摘要格式（适合报告展示）
- 默认: `table`
- 示例: `"table"`

### hints (可选)
- 类型: object
- 说明: 查询优化提示，帮助系统更准确地理解查询意图
- 支持的提示字段:
  - `prefer_model`: 优先使用的数据模型名称
  - `prefer_fields`: 优先返回的字段列表
  - `time_range`: 时间范围提示
  - `filters`: 预设的过滤条件
- 示例:
```json
{
  "prefer_model": "TmsCustomerModel",
  "prefer_fields": ["customerName", "customerTel"],
  "time_range": "last_7_days"
}
```

### stream (可选)
- 类型: boolean
- 说明: 启用流式响应
- 推荐场景:
  - 大数据量查询
  - 需要实时反馈进度
  - 改善用户体验
- 默认: `true`

## 返回值说明

### 成功响应示例

**包含图表的响应**：
```json
{
  "type": "result",
  "items": [
    {"date": "2025-09-15", "amount": 12500},
    {"date": "2025-09-16", "amount": 13200}
  ],
  "total": 2,
  "summary": "查询到2条记录",
  "exports": {
    "charts": [
      {
        "url": "https://chart.example.com/trend.png",
        "type": "LINE",
        "title": "近一周销售趋势图",
        "format": "PNG",
        "width": 800,
        "height": 600,
        "expiresAt": "2025-09-22T12:00:00Z"
      }
    ]
  },
  "hasNext": false,
  "nextCursor": null
}
```

### 响应字段说明
- **type**: 响应类型（result/error/info）
- **items**: 数据记录数组
- **total**: 总记录数
- **summary**: 查询结果摘要
- **exports**: 导出文件对象
  - **charts**: 图表数组，每个图表包含：
    - url: 图表URL（云端托管，直接可访问）
    - type: 图表类型（LINE/BAR/PIE/SCATTER）
    - title: 图表标题（AI自动生成，具有业务含义）
    - format: 图片格式（PNG/JPG/SVG）
    - width/height: 图片尺寸
    - expiresAt: 过期时间
- **hasNext**: 是否有下一页
- **nextCursor**: 下一页游标

## AI规范兼容性

本工具完全遵循AI标准规范，确保生成的内容可以被AI模型和客户端正确处理：

### 图表输出规范
- ✅ 图表URL云端托管，直接可访问
- ✅ 支持多种输出格式（PNG、JPG、SVG）
- ✅ 包含完整的元数据（宽度、高度、类型、过期时间）
- ✅ AI自动生成有意义的图表标题
- ✅ 图表类型明确标识（LINE/BAR/PIE等）

### 响应结构规范
- ✅ 使用标准化的 `exports` 字段
- ✅ charts为数组，支持多个文件
- ✅ 每个导出对象包含完整的元数据
- ✅ 统一的过期时间管理机制

## 智能特性

### 意图识别
系统会自动识别查询意图并选择合适的处理方式：
- **明细查询**: 返回详细数据列表
- **统计查询**: 执行聚合计算并返回统计结果
- **趋势分析**: 自动生成折线图展示趋势
- **对比分析**: 自动生成柱状图进行对比
- **占比分析**: 自动生成饼图展示占比

### 多步骤分析能力
系统具备强大的多步骤数据分析能力，可以将复杂问题分解为多个查询步骤，并智能整合结果：

**典型分析场景**：

1. **客户深度分析**：
   - 查询: "找出2025-01月发货量前10的客户，分析他们2025年的发货量"
   - 步骤1: 查询2025-01月发货量前10的客户，获取客户ID列表
   - 步骤2: 根据客户ID列表查询2025年全年的订单量
   - 步骤3: 生成综合分析报告，对比月度和全年表现

2. **分层统计分析**：
   - 查询: "分析不同等级企业客户的分布情况"
   - 步骤1: 查询所有企业客户总数
   - 步骤2: 按客户等级分组统计企业客户
   - 步骤3: 整合数据生成分布分析报告

3. **关联分析**：
   - 查询: "找出最活跃的客户并分析其特征"
   - 步骤1: 查询订单量最多的客户
   - 步骤2: 查询这些客户的详细信息
   - 步骤3: 综合分析客户特征和行为模式

4. **趋势对比分析**：
   - 查询: "对比各网点近三个月的业绩变化"
   - 步骤1: 查询每个网点每月的订单量
   - 步骤2: 计算环比增长率
   - 步骤3: 生成趋势对比图表和分析报告

**智能整合能力**：
- ✅ 自动将多个查询结果进行关联和整合
- ✅ 在summary中体现数据间的关联关系和洞察
- ✅ 提供具有业务价值的分析结论
- ✅ 必要时生成对比图表展示分析结果
- ✅ 明确说明执行了哪些查询步骤
- ✅ 提供进一步分析的建议

**使用建议**：
- 对于复杂问题，直接描述分析目标，系统会自动分解步骤
- 无需手动拆分查询，AI会智能规划最优查询路径
- 系统会在响应中说明执行的步骤，保持透明度

### 图表自动生成
- **趋势查询** → 自动生成折线图（LINE）
- **分类统计** → 自动生成柱状图（BAR）
- **占比分析** → 自动生成饼图（PIE）
- **相关性分析** → 自动生成散点图（SCATTER）

### 标题智能生成
AI会根据查询内容自动生成有意义的图表标题：
- "近一周的运单趋势" → "近一周运单趋势图"
- "按客户类型统计" → "客户类型分布图"
- "各地区销售占比" → "各地区销售占比图"

### 上下文记忆
通过 `session_id` 参数，系统可以：
- 记住之前查询的模型
- 保持字段选择的一致性
- 支持追问和细化查询
- 提供连续的对话体验

## 性能优化建议

1. **使用session_id**: 连续查询时使用session_id可以减少重复的模型识别开销
2. **启用流式响应**: 大数据量查询建议设置 `stream: true` 获得更好体验
3. **合理的分页**: 使用cursor进行分页，避免一次性加载过多数据
4. **精确的查询**: 提供明确的查询条件可以提升查询性能和准确性
5. **使用hints**: 在查询意图明确时，使用hints可以提高识别准确率

## 错误处理

### 常见错误

1. **QUERY_PARSE_ERROR**: 查询语句无法理解
   - 解决: 使用更明确的查询语句，提供更多上下文

2. **MODEL_NOT_FOUND**: 无法识别查询对应的数据模型
   - 解决: 在hints中指定prefer_model，或提供更具体的查询描述

3. **FIELD_NOT_FOUND**: 查询中提到的字段不存在
   - 解决: 检查字段名称是否正确，或使用更通用的描述

4. **QUERY_TIMEOUT**: 查询超时
   - 解决: 缩小查询范围，使用更具体的过滤条件

5. **CHART_GENERATION_FAILED**: 图表生成失败
   - 解决: 检查查询结果数据格式是否正确

## 最佳实践

### 查询语句编写
- ✅ 使用明确的业务术语："查询客户信息" 而不是 "给我看看数据"
- ✅ 指定时间范围："近一周的订单" 而不是 "最近的订单"
- ✅ 明确统计维度："按网点统计" 而不是 "统计一下"
- ✅ 提供过滤条件："北京地区的企业客户" 而不是 "一些客户"

### 会话管理
- 首次查询可以不提供session_id
- 连续查询建议使用相同的session_id
- session_id有效期通常为30分钟

### 输出格式选择
- 查看明细数据 → 使用 `format: "table"`
- 程序处理数据 → 使用 `format: "json"`
- 生成报告摘要 → 使用 `format: "summary"`

### 大数据量处理
- 首次查询限制返回数量
- 使用cursor进行分页浏览
- 启用stream获得进度反馈

## 与其他工具的关系

- **M1层工具**: `dataset_nl.query` 是唯一的M1层入口工具
- **M2层工具**: 内部会调用 `query_model_v2`、`export_with_chart` 等M2工具
- **工具链**: 外部Agent → M1 (dataset_nl.query) → M2 (多个专业工具) → 返回结果

## 注意事项

- 所有查询均使用中文自然语言
- 图表URL有过期时间（通常24小时）
- 大数据量查询可能需要较长时间处理
- 使用session_id可以提升连续查询的体验
- charts字段始终为数组，即使只有一个文件
- 图表标题由AI自动生成，确保有业务含义
