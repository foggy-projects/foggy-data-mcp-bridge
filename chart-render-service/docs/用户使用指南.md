# 图形渲染服务使用指南

## 概述

图形渲染服务是一个基于Node.js + ECharts + Puppeteer的高性能图表渲染微服务，提供统一语义和原生ECharts两种渲染模式，支持将图表配置转换为PNG、SVG等图片格式。

## 快速开始

### 服务信息
- **服务地址**: `http://localhost:3001`
- **认证方式**: Header中携带`Authorization: default-render-token`
- **支持格式**: PNG, SVG
- **最大尺寸**: 4000x4000像素

### 健康检查
```bash
curl http://localhost:3001/healthz
```

## API接口

### 1. 原生ECharts渲染

#### JSON响应模式

**端点**: `POST /render/native`

**描述**: 使用原生ECharts配置进行图表渲染，返回JSON格式响应

**请求头**:
```
Authorization: default-render-token
Content-Type: application/json
```

**请求体**:
```json
{
  "engine": "echarts",
  "engine_spec": {
    "title": {"text": "图表标题"},
    "xAxis": {
      "type": "category",
      "data": ["一月", "二月", "三月", "四月", "五月"]
    },
    "yAxis": {"type": "value"},
    "series": [{
      "data": [120, 200, 150, 80, 70],
      "type": "bar"
    }]
  },
  "image": {
    "format": "png",
    "width": 800,
    "height": 600,
    "backgroundColor": "#ffffff"
  }
}
```

**响应**:
```json
{
  "success": true,
  "renderTime": 2500,
  "format": "png",
  "size": {
    "width": 800,
    "height": 600
  },
  "image": "iVBORw0KGgoAAAANSUhEUgAAA...",
  "mimeType": "image/png"
}
```

#### 文件流响应模式

**端点**: `POST /render/native/stream`

**描述**: 使用原生ECharts配置进行图表渲染，直接返回图片文件流

**请求参数**: 与JSON模式完全相同

**响应**: 直接返回图片文件的二进制流，适用于需要直接下载或保存图片的场景

**示例**:
```bash
curl -X POST http://localhost:3001/render/native/stream \
  -H "Authorization: default-render-token" \
  -H "Content-Type: application/json" \
  -d '{
    "engine": "echarts",
    "engine_spec": {
      "title": {"text": "图表标题"},
      "xAxis": {"type": "category", "data": ["A", "B", "C"]},
      "yAxis": {"type": "value"},
      "series": [{"data": [100, 200, 300], "type": "bar"}]
    },
    "image": {"format": "png", "width": 800, "height": 600}
  }' \
  --output my_chart.png
```

### 2. 统一语义渲染

#### JSON响应模式

**端点**: `POST /render/unified`

**描述**: 使用统一图表语义进行渲染，返回JSON格式响应

**请求体**:
```json
{
  "unified": {
    "type": "bar",
    "title": "销售数据",
    "xField": "month",
    "yField": "sales",
    "topN": 10,
    "color": "#5470c6"
  },
  "data": [
    {"month": "一月", "sales": 1200},
    {"month": "二月", "sales": 1500},
    {"month": "三月", "sales": 1100}
  ],
  "image": {
    "format": "png",
    "width": 800,
    "height": 600
  }
}
```

**支持的图表类型**:
- `bar` - 柱状图
- `column` - 条形图
- `line` - 折线图
- `pie` - 饼图
- `doughnut` - 环形图
- `scatter` - 散点图
- `area` - 面积图

#### 文件流响应模式

**端点**: `POST /render/unified/stream`

**描述**: 使用统一图表语义进行渲染，直接返回图片文件流

**请求参数**: 与JSON模式完全相同

**示例**:
```bash
curl -X POST http://localhost:3001/render/unified/stream \
  -H "Authorization: default-render-token" \
  -H "Content-Type: application/json" \
  -d '{
    "unified": {
      "type": "bar",
      "title": "销售数据",
      "xField": "product",
      "yField": "sales"
    },
    "data": [
      {"product": "产品A", "sales": 1000},
      {"product": "产品B", "sales": 800}
    ],
    "image": {"format": "png", "width": 600, "height": 400}
  }' \
  --output sales_chart.png
```

### 3. 其他接口

#### 健康检查
- `GET /healthz` - 基础健康检查
- `GET /healthz/detailed` - 详细系统信息
- `GET /healthz/ready` - 就绪状态检查

#### 队列状态
- `GET /render/queue/status` - 获取渲染队列状态

## 参数说明

### 图片规格 (image)
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| format | string | 否 | png | 图片格式：png, svg |
| width | number | 否 | 800 | 图片宽度 (100-4000) |
| height | number | 否 | 600 | 图片高度 (100-4000) |
| quality | number | 否 | 1.0 | 图片质量 (仅JPEG) |
| backgroundColor | string | 否 | #ffffff | 背景色 |

### 统一语义配置 (unified)
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | string | 是 | 图表类型 |
| title | string | 否 | 图表标题 |
| xField | string | 否 | X轴字段名 |
| yField | string | 否 | Y轴字段名 |
| nameField | string | 否 | 名称字段 (饼图) |
| valueField | string | 否 | 数值字段 (饼图) |
| topN | number | 否 | 显示前N项数据 |
| color | string | 否 | 主色调 |
| smooth | boolean | 否 | 平滑曲线 (折线图) |
| showLegend | boolean | 否 | 显示图例 |

## 使用示例

### JavaScript/Node.js

```javascript
const axios = require('axios');

async function renderChart() {
  try {
    const response = await axios.post('http://localhost:3001/render/native', {
      engine: 'echarts',
      engine_spec: {
        title: { text: '销售趋势' },
        xAxis: {
          type: 'category',
          data: ['Q1', 'Q2', 'Q3', 'Q4']
        },
        yAxis: { type: 'value' },
        series: [{
          data: [820, 932, 901, 934],
          type: 'line'
        }]
      },
      image: {
        format: 'png',
        width: 600,
        height: 400
      }
    }, {
      headers: {
        'Authorization': 'default-render-token',
        'Content-Type': 'application/json'
      }
    });

    if (response.data.success) {
      // 保存图片
      const imageBuffer = Buffer.from(response.data.image, 'base64');
      require('fs').writeFileSync('chart.png', imageBuffer);
      console.log('图表渲染成功！');
    }
  } catch (error) {
    console.error('渲染失败:', error.response?.data || error.message);
  }
}

renderChart();
```

**文件流模式示例**:
```javascript
const fs = require('fs');

async function renderChartStream() {
  try {
    const response = await axios.post('http://localhost:3001/render/native/stream', {
      engine: 'echarts',
      engine_spec: {
        title: { text: '销售趋势' },
        xAxis: {
          type: 'category',
          data: ['Q1', 'Q2', 'Q3', 'Q4']
        },
        yAxis: { type: 'value' },
        series: [{
          data: [820, 932, 901, 934],
          type: 'line'
        }]
      },
      image: {
        format: 'png',
        width: 600,
        height: 400
      }
    }, {
      headers: {
        'Authorization': 'default-render-token',
        'Content-Type': 'application/json'
      },
      responseType: 'stream'  // 关键：设置响应类型为流
    });

    // 直接保存文件流
    const writer = fs.createWriteStream('chart.png');
    response.data.pipe(writer);

    writer.on('finish', () => {
      console.log('图表文件保存成功！');
      console.log('渲染时间:', response.headers['x-render-time'] + 'ms');
      console.log('图表类型:', response.headers['x-chart-type']);
    });

  } catch (error) {
    console.error('渲染失败:', error.response?.data || error.message);
  }
}

renderChartStream();
```

### Python

```python
import requests
import base64

def render_chart():
    url = 'http://localhost:3001/render/native'
    headers = {
        'Authorization': 'default-render-token',
        'Content-Type': 'application/json'
    }

    data = {
        'engine': 'echarts',
        'engine_spec': {
            'title': {'text': '销售数据'},
            'xAxis': {
                'type': 'category',
                'data': ['产品A', '产品B', '产品C', '产品D']
            },
            'yAxis': {'type': 'value'},
            'series': [{
                'data': [120, 200, 150, 80],
                'type': 'bar'
            }]
        },
        'image': {
            'format': 'png',
            'width': 800,
            'height': 600
        }
    }

    try:
        response = requests.post(url, json=data, headers=headers)
        result = response.json()

        if result.get('success'):
            # 保存图片
            image_data = base64.b64decode(result['image'])
            with open('chart.png', 'wb') as f:
                f.write(image_data)
            print(f"图表渲染成功！耗时: {result['renderTime']}ms")
        else:
            print(f"渲染失败: {result}")

    except Exception as e:
        print(f"请求失败: {e}")

render_chart()
```

**文件流模式示例**:
```python
import requests

def render_chart_stream():
    url = 'http://localhost:3001/render/native/stream'
    headers = {
        'Authorization': 'default-render-token',
        'Content-Type': 'application/json'
    }

    data = {
        'engine': 'echarts',
        'engine_spec': {
            'title': {'text': '销售数据'},
            'xAxis': {
                'type': 'category',
                'data': ['产品A', '产品B', '产品C', '产品D']
            },
            'yAxis': {'type': 'value'},
            'series': [{
                'data': [120, 200, 150, 80],
                'type': 'bar'
            }]
        },
        'image': {
            'format': 'png',
            'width': 800,
            'height': 600
        }
    }

    try:
        # 使用stream=True获取文件流
        response = requests.post(url, json=data, headers=headers, stream=True)

        if response.status_code == 200:
            # 直接保存文件流
            with open('chart.png', 'wb') as f:
                for chunk in response.iter_content(chunk_size=8192):
                    f.write(chunk)

            print("图表文件保存成功！")
            print(f"渲染时间: {response.headers.get('X-Render-Time')}ms")
            print(f"图表类型: {response.headers.get('X-Chart-Type')}")
            print(f"文件大小: {response.headers.get('Content-Length')} bytes")
        else:
            print(f"渲染失败，状态码: {response.status_code}")

    except Exception as e:
        print(f"请求失败: {e}")

render_chart_stream()
```

### cURL

```bash
# 柱状图渲染
curl -X POST http://localhost:3001/render/native \
  -H "Authorization: default-render-token" \
  -H "Content-Type: application/json" \
  -d '{
    "engine": "echarts",
    "engine_spec": {
      "title": {"text": "月度销售额"},
      "xAxis": {
        "type": "category",
        "data": ["1月", "2月", "3月", "4月"]
      },
      "yAxis": {"type": "value"},
      "series": [{
        "data": [2340, 1890, 2560, 2100],
        "type": "bar",
        "itemStyle": {"color": "#5470c6"}
      }]
    },
    "image": {
      "format": "png",
      "width": 800,
      "height": 600
    }
  }' | jq '.success'

# 饼图渲染
curl -X POST http://localhost:3001/render/unified \
  -H "Authorization: default-render-token" \
  -H "Content-Type: application/json" \
  -d '{
    "unified": {
      "type": "pie",
      "title": "市场份额",
      "nameField": "category",
      "valueField": "value"
    },
    "data": [
      {"category": "移动端", "value": 60},
      {"category": "桌面端", "value": 35},
      {"category": "其他", "value": 5}
    ],
    "image": {
      "format": "png",
      "width": 600,
      "height": 600
    }
  }'
```

## 高级功能

### 1. TopN数据处理

统一语义模式支持自动TopN处理，当数据量超过指定阈值时，会自动截取前N项数据并将其余项合并为"其他"：

```json
{
  "unified": {
    "type": "bar",
    "topN": 5,
    "xField": "product",
    "yField": "sales"
  },
  "data": [
    {"product": "产品A", "sales": 1000},
    {"product": "产品B", "sales": 800},
    // ... 更多数据
  ]
}
```

### 2. 样式自定义

```json
{
  "engine_spec": {
    "title": {
      "text": "自定义样式图表",
      "textStyle": {
        "fontSize": 18,
        "fontWeight": "bold",
        "color": "#333"
      }
    },
    "grid": {
      "left": "10%",
      "right": "10%",
      "top": "15%",
      "bottom": "15%"
    },
    "series": [{
      "type": "bar",
      "data": [120, 200, 150],
      "itemStyle": {
        "color": {
          "type": "linear",
          "x": 0, "y": 0, "x2": 0, "y2": 1,
          "colorStops": [
            {"offset": 0, "color": "#83bff6"},
            {"offset": 1, "color": "#188df0"}
          ]
        }
      }
    }]
  }
}
```

### 3. 多系列图表

```json
{
  "engine_spec": {
    "title": {"text": "多系列对比"},
    "legend": {"data": ["销售额", "利润"]},
    "xAxis": {
      "type": "category",
      "data": ["Q1", "Q2", "Q3", "Q4"]
    },
    "yAxis": {"type": "value"},
    "series": [
      {
        "name": "销售额",
        "type": "bar",
        "data": [2000, 2200, 1800, 2400]
      },
      {
        "name": "利润",
        "type": "line",
        "data": [200, 280, 160, 320]
      }
    ]
  }
}
```

## 错误处理

### 常见错误码

| 状态码 | 错误信息 | 说明 |
|--------|----------|------|
| 401 | Unauthorized | 认证token无效 |
| 400 | Validation Error | 请求参数验证失败 |
| 422 | Render Error | 图表渲染失败 |
| 408 | Request Timeout | 渲染超时 |
| 429 | Too Many Requests | 请求频率过高 |

### 错误响应格式

```json
{
  "error": "Validation Error",
  "message": "Invalid request: width must be between 100 and 4000",
  "timestamp": "2024-09-19T16:30:00.000Z",
  "requestId": "render_123456789"
}
```

### 故障排查

1. **认证失败**
   - 检查Authorization头是否正确设置
   - 确认token是否匹配服务配置

2. **渲染超时**
   - 减少图表复杂度
   - 降低数据点数量
   - 检查服务器资源

3. **参数验证失败**
   - 检查图片尺寸是否在允许范围内
   - 确认ECharts配置语法正确
   - 验证数据格式

## 性能优化

### 1. 数据量控制
- 建议单个图表数据点不超过1000个
- 使用TopN功能自动截取数据
- 对于大数据集，考虑服务端预聚合

### 2. 缓存策略
- 相同配置的图表可以缓存结果
- 使用配置哈希值作为缓存键
- 设置合理的缓存过期时间

### 3. 并发控制
- 服务默认支持10个并发渲染任务
- 避免同时提交大量渲染请求
- 使用队列状态接口监控负载

## 监控和日志

### 监控指标
- 渲染成功率
- 平均渲染时间
- 队列长度
- 内存使用率

### 日志级别
- `INFO`: 关键业务事件
- `DEBUG`: 详细调试信息
- `WARN`: 警告信息
- `ERROR`: 错误信息

### 性能基准
- 简单柱状图: ~1-2秒
- 复杂多系列图: ~3-5秒
- 大数据量图表: ~5-10秒

## 最佳实践

1. **图表设计**
   - 保持图表简洁清晰
   - 合理设置图片尺寸
   - 选择合适的图表类型

2. **数据处理**
   - 在客户端预处理数据
   - 使用适当的数据格式
   - 避免传输不必要的字段

3. **错误处理**
   - 实现重试机制
   - 设置合理的超时时间
   - 记录详细的错误信息

4. **集成建议**
   - 使用连接池管理HTTP连接
   - 实现熔断机制防止级联故障
   - 监控服务健康状态

## 技术支持

如遇问题，请检查：
1. 服务是否正常运行 (`/healthz`)
2. 认证配置是否正确
3. 请求参数是否符合规范
4. 服务器资源是否充足

更多技术细节请参考项目README.md文档。